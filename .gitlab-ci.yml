---

image: "${CI_REGISTRY}/gitlab-com/gl-infra/k8s-workloads/common/k8-helm-ci:latest"

include:
  - project: "gitlab-com/gl-infra/k8s-workloads/common"
    file: "/ci/except-com.yml"
  - project: "gitlab-com/gl-infra/k8s-workloads/common"
    file: "/ci/cluster-init-before-script.yml"
  - project: "gitlab-com/gl-infra/k8s-workloads/common"
    file: "/ci/shellcheck.yml"

.deploy:
  extends:
    - .except-com
    - .cluster-init-before-script


.pre:
  environment:
    name: pre
    url: https://pre.gitlab.com

.staging:
  environment:
    name: gstg
    url: https://staging.gitlab.com

stages:
  - check
  - dryrun
  - deploy

############################ CI JOBS ################################
#####################################################################

### PreProd

upgrade_pre_dryrun:
  stage: dryrun
  extends:
    - .deploy
    - .pre
  script:
    - bin/k-ctl -D upgrade

upgrade_pre:
  stage: deploy
  extends:
    - .deploy
    - .pre
  script:
    - bin/k-ctl upgrade
  only:
    refs:
      - master

### Staging

upgrade_staging_dryrun:
  stage: dryrun
  extends:
    - .deploy
    - .staging
  script:
    - bin/k-ctl -D upgrade

upgrade_staging:
  stage: deploy
  extends:
    - .deploy
    - .staging
  script:
    - bin/upgrade upgrade
  only:
    refs:
      - master
