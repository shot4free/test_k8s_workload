---

image: "${CI_REGISTRY}/gitlab-com/gl-infra/k8s-workloads/common/k8-helm-ci:latest"

include:
  - project: "gitlab-com/gl-infra/k8s-workloads/common"
    file: "/ci/except-com.yml"
  - project: "gitlab-com/gl-infra/k8s-workloads/common"
    file: "/ci/cluster-init-before-script.yml"
  - project: "gitlab-com/gl-infra/k8s-workloads/common"
    file: "/ci/shellcheck.yml"

stages:
  - check
  - deploy

############################ CI JOBS ################################
#####################################################################

kubeval:
  stage: check
  allow_failure: true
  script: |
    ./bin/kubeval-wrapper.sh

deploy_pre:
  extends:
    - .except-com
    - .cluster-init-before-script
  stage: deploy
  when: manual
  environment:
    name: pre
    url: https://pre.gitlab.com
  script:
    - kubectl apply --recursive --filename output/${CI_ENVIRONMENT_SLUG}/handcrafted
    - kubectl apply --recursive --filename output/${CI_ENVIRONMENT_SLUG}/gitlab
  only:
    - master
