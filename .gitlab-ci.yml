---

image: registry.ops.gitlab.net/gitlab-com/gl-infra/k8s-workloads/common/k8-helm-ci:latest

include:
  - project: "gitlab-com/gl-infra/k8s-workloads/common"
    file: "/ci/except-gitlab-com.yml"
  - project: "gitlab-com/gl-infra/k8s-workloads/common"
    file: "/ci/helm-before-script-except-com.yml"
  - project: "gitlab-com/gl-infra/k8s-workloads/common"
    file: "/ci/shellcheck.yml"

stages:
  - check
  - deploy

############################ CI JOBS ################################
#####################################################################


.deploy:
  extends:
    - .except-gitlab-com
    - .cluster-init-before-script-except-com
  script: |
    kubectl apply --recursive --filename output/${CI_ENVIRONMENT_SLUG}/handcrafted
    kubectl apply --recursive --filename output/${CI_ENVIRONMENT_SLUG}/gitlab

kubeval:
  stage: check
  allow_failure: true
  script: |
    ./bin/kubeval-wrapper.sh

deploy_pre:
  extends: .deploy
  stage: deploy
  when: manual
  environment:
    name: pre
    url: https://pre.gitlab.com
  only:
    - master
