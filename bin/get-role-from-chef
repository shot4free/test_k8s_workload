#!/usr/bin/env bash
# vim: ai:ts=2:sw=2:et

set -euf -o pipefail

fail() {
  usage
  exit 1
}

usage() {
  cat <<EOF
$0: get a chef role object as json from the chef-repo
on ops.gitlab.net via git. Needs environment variable
GITLAB_OPS_API_TOKEN to be set.

USAGE:
$0 role_name

e.g. $0 gprd-base
EOF
}

if [[ $# -eq 0 ]]; then
  usage
  exit 1
else
  ROLE=${1}
fi

main() {

  if [[ -z "${GITLAB_OPS_API_TOKEN}" ]]; then
    echo "GITLAB_OPS_API_TOKEN is not set!"
    exit 2
  else
    curl -s --fail --retry 5 -H "PRIVATE-TOKEN: $GITLAB_OPS_API_TOKEN" "https://ops.gitlab.net/api/v4/projects/139/repository/files/roles%2F${ROLE}.json/raw?ref=master"
  fi

}

main
