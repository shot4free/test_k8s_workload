#!/usr/bin/env bash

##############################
# Generates gitlab kubernetes
# configuration using `helm template`

set -euf -o pipefail
dir="$(cd "$(dirname "${0}")"; pwd)"
source "$dir/.setup.bash"
source "$dir/.gitlab.bash"

manifests_dir="$dir/../manifests"
rm -rf "${manifests_dir:?}/*"

charts_dir=$(mktemp -d)
update_gitlab_chart "$charts_dir"

opts=(
    "$charts_dir"
    "--output-dir" "$manifests_dir"
    "--namespace" "$NAMESPACE"
    "${HELM_OPTS[@]}"
    "${HELM_OPTS_VALUES[@]}"
)

set -x
helm tiller run helm template "${opts[@]}" "$@"
set +x
rm -rf "${charts_dir:?}"
