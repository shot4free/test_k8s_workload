---

# Force PreProd config for https://gitlab.com/gitlab-com/gl-infra/k8s-workloads/gitlab-com/-/merge_requests/1163
nginx-ingress:
  controller:
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - ingress-nginx
                  - key: app.kubernetes.io/instance
                    operator: In
                    values:
                      - ingress-nginx
                  - key: app.kubernetes.io/component
                    operator: In
                    values:
                      - controller
              topologyKey: kubernetes.io/hostname
    nodeSelector:
      cloud.google.com/gke-nodepool: default-1

registry:
  database:
    enabled: true
    host: 10.33.1.2
    user: registry
    name: registry_production
    password:
      secret: registry-postgresql-password-v1
    pool:
      maxopen: 5
      maxidle: 5
      maxlifetime: 5m
  migration:
    enabled: true
    disablemirrorfs: true
    rootdirectory: gitlab
  nodeSelector:
    cloud.google.com/gke-nodepool: default-1
  gc:
    disabled: false
    maxbackoff: 30m
    reviewafter: 5m
    noidlebackoff: true
  storage:
    secret: registry-storage-v4
  maintenance:
    uploadpurging:
      enabled: false
  image:
    tag: v3.11.0-gitlab

gitlab:
  webservice:
    hpa:
      minReplicas: 2
      maxReplicas: 5
    # blackoutSeconds, minReplicas, initialDelaySeconds, terminationGracePeriodSeconds
    # set temporarily for
    # testing https://gitlab.com/gitlab-com/gl-infra/delivery/-/issues/1509
    shutdown:
      blackoutSeconds: 0
    deployments:
      api:
        extraEnv:
          GITLAB_CONTINUOUS_PROFILING: stackdriver?service=workhorse-api
          GITLAB_SENTRY_EXTRA_TAGS: "{\"type\": \"api\", \"stage\": \"main\"}"
        ingress:
          path: '/api'
        nodeSelector:
          cloud.google.com/gke-nodepool: default-1
      git:
        nodeSelector:
          cloud.google.com/gke-nodepool: default-1
        shutdown:
          blackoutSeconds: 0
      web:
        nodeSelector:
          cloud.google.com/gke-nodepool: default-1
      websockets:
        deployment:
          readinessProbe:
            initialDelaySeconds: 0
          terminationGracePeriodSeconds: 30
        nodeSelector:
          cloud.google.com/gke-nodepool: default-1
        shutdown:
          blackoutSeconds: 0
    workerProcesses: 2
    workhorse:
      resources:
        limits:
          memory: 1G
        requests:
          cpu: 100m
          memory: 50M
    resources:
      limits:
        memory: 4.0G
      requests:
        cpu: 1
        memory: 1.25G
    extraEnv:
      DISABLE_PUMA_NAKAYOSHI_FORK: "true"
      GITLAB_SIDEKIQ_SIZE_LIMITER_MODE: compress
      GITLAB_SIDEKIQ_SIZE_LIMITER_LIMIT_BYTES: "5000000"
      GITLAB_SIDEKIQ_SIZE_LIMITER_COMPRESSION_THRESHOLD_BYTES: "100000"
  gitlab-shell:
    minReplicas: 2
    maxReplicas: 5
    nodeSelector:
      cloud.google.com/gke-nodepool: default-1
  mailroom:
    nodeSelector:
      cloud.google.com/gke-nodepool: default-1
  sidekiq:
    pods:
      - name: catchall
        common:
          labels:
            shard: catchall
        nodeSelector:
          cloud.google.com/gke-nodepool: default-1
        concurrency: 25
        minReplicas: 1
        maxReplicas: 5
    psql:
      host: 10.33.1.14
  kas:
    image:
      tag: v14.3.0
    hpa:
      minReplicas: 1
      maxReplicas: 5
    nodeSelector:
      cloud.google.com/gke-nodepool: default-1
global:
  appConfig:
    contentSecurityPolicy:
      enabled: true
      report_only: false
      directives:
        connect_src: "'self' https://pre.gitlab.com https://pre.gitlab-static.net wss://pre.gitlab.com https://sentry.gitlab.net https://customers.gitlab.com https://snowplow.trx.gitlab.net https://sourcegraph.com https://ec2.ap-east-1.amazonaws.com https://ec2.ap-northeast-1.amazonaws.com https://ec2.ap-northeast-2.amazonaws.com https://ec2.ap-northeast-3.amazonaws.com https://ec2.ap-south-1.amazonaws.com https://ec2.ap-southeast-1.amazonaws.com https://ec2.ap-southeast-2.amazonaws.com https://ec2.ca-central-1.amazonaws.com https://ec2.eu-central-1.amazonaws.com https://ec2.eu-north-1.amazonaws.com https://ec2.eu-west-1.amazonaws.com https://ec2.eu-west-2.amazonaws.com https://ec2.eu-west-3.amazonaws.com https://ec2.me-south-1.amazonaws.com https://ec2.sa-east-1.amazonaws.com https://ec2.us-east-1.amazonaws.com https://ec2.us-east-2.amazonaws.com https://ec2.us-west-1.amazonaws.com https://ec2.us-west-2.amazonaws.com https://ec2.af-south-1.amazonaws.com https://iam.amazonaws.com"
        default_src: "'self' https://pre.gitlab-static.net"
        frame_ancestors: "'self'"
        frame_src: "'self' https://pre.gitlab-static.net https://www.google.com/recaptcha/ https://www.recaptcha.net/ https://content.googleapis.com https://content-cloudresourcemanager.googleapis.com https://content-compute.googleapis.com https://content-cloudbilling.googleapis.com https://*.codesandbox.io"
        img_src: "* data: blob:"
        object_src: "'none'"
        report_uri: "https://sentry.gitlab.net/api/22/security/?sentry_key=e9401448c5c04c39823793199b8f7c49"
        script_src: "'self' 'unsafe-inline' 'unsafe-eval' https://pre.gitlab-static.net https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/ https://www.recaptcha.net/ https://apis.google.com"
        style_src: "'self' 'unsafe-inline' https://pre.gitlab-static.net"
        worker_src: "https://pre.gitlab-static.net https://pre.gitlab.com blob: data:"
    omniauth:
      providers:
        - secret: gitlab-google-oauth2-v1

  email:
    reply_to: noreply@pre.gitlab.com

  hosts:
    gitlab:
      name: pre.gitlab.com
    kas:
      name: kas.pre.gitlab.com
