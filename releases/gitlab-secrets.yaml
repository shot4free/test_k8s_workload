---
helmDefaults:
  tillerNamespace: kube-system
  tillerless: true
  cleanupOnFail: false
  wait: true
  timeout: 600
  recreatePods: true
  force: true

repositories:
# Kubernetes incubator repo of helm charts
- name: "kubernetes-incubator"
  url: "https://kubernetes-charts-incubator.storage.googleapis.com"

releases:
- name: 'gitlab-secrets'
  chart: "kubernetes-incubator/raw"
  namespace: gitlab
  version: "0.2.3"
  installed: {{ env "GITLAB_SECRETS_INSTALLED" | default "true" }}
  values:
    - google_project: {{ env "PROJECT" }}
    - gitlab_endpoint: {{ env "GITLAB_ENDPOINT" }}
{{- $gkms_omnibus_secrets_base64 := (exec "bash" (list "-c" (print "gsutil cat gs://gitlab-" .Environment.Name "-secrets/gitlab-omnibus-secrets/" .Environment.Name ".enc | gcloud --project " .Values.google_project " kms decrypt --location global --keyring=gitlab-secrets --key " .Environment.Name " --ciphertext-file=- --plaintext-file=-")) | b64enc | quote) }}
{{- $dev_gitlab_org_docker_pass := exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -jc '.gitlab_k8s.\"k8s-workloads-deploy-token\"'")) }}
    - resources:
      - apiVersion: v1
        kind: Secret
        type: kubernetes.io/dockerconfigjson
        metadata:
          name: dev-registry-access
          namespace: gitlab
        stringData:
          .dockerconfigjson: |
            {"auths":{"dev.gitlab.org:5005":{"username":"k8s-workloads-deploy-token","password":{{ $dev_gitlab_org_docker_pass | quote }},"auth":{{ (list "k8s-workloads-deploy-token:" $dev_gitlab_org_docker_pass) | join "" | b64enc | quote }}}}}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: gitlab-object-storage
          namespace: gitlab
        stringData:
          gitlab-object-storage.yml: |
              provider: Google
              google_project: {{ .Values.google_project }}
              google_json_key_string: |
{{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -r '.\"gitlab-server\".\"google-creds\".json_base64'")) | b64dec | trimSuffix "\n" | indent 16 }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: gitlab-google-oauth2
          namespace: gitlab
        stringData:
          provider:
{{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -jc '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-rails\".omniauth_providers[0]'")) | quote | indent 14 }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: registry-certificate
          namespace: gitlab
        stringData:
          registry-auth.crt: |
{{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -r '.\"omnibus-gitlab\".gitlab_rb.registry.internal_certificate'")) | indent 14 }}
          registry-auth.key: |
{{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -r '.\"omnibus-gitlab\".gitlab_rb.registry.internal_key'")) | indent 14 }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: registry-storage
          namespace: gitlab
        stringData:
          config: |
            gcs:
              bucket: gitlab-{{ .Environment.Name }}-registry
              keyfile: /etc/docker/registry/storage/gcs.json
            maintenance:
              uploadpurging:
                enabled: false
            cache:
              blobdescriptor: 'inmemory'
            delete:
              enabled: true
          gcs.json: |
{{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -r '.\"gitlab-server\".\"google-creds\".json_base64'")) | b64dec | trimSuffix "\n" | indent 14 }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: registry-httpsecret
          namespace: gitlab
        stringData:
          secret: {{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.registry.http_secret'")) | quote }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: gitlab-postgres-credential
          namespace: gitlab
        stringData:
          secret: {{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-rails\".db_password'")) | quote }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: gitlab-redis-credential
          namespace: gitlab
        stringData:
          secret: {{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-rails\".redis_password'")) | quote }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: gitlab-smtp-credential
          namespace: gitlab
        stringData:
          secret: {{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-rails\".smtp_password'")) | quote }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: gitlab-workhorse-credential
          namespace: gitlab
        stringData:
          secret: {{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-workhorse\".secret_token'")) | quote }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: gitlab-gitaly-credential
          namespace: gitlab
        stringData:
          secret: {{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-rails\".gitaly_token'")) | quote }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: gitlab-rails-secret
          namespace: gitlab
        stringData:
          secrets.yml: |
            production:
              secret_key_base: {{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-rails\".secret_key_base'")) }}
              otp_key_base: {{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-rails\".otp_key_base'")) }}
              db_key_base: {{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-rails\".db_key_base'")) }}
              openid_connect_signing_key: |
{{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-rails\".openid_connect_signing_key'")) | trimSuffix "\n" | indent 16 }}
      - apiVersion: v1
        kind: Secret
        metadata:
          name: gitlab-mailroom-imap
          namespace: gitlab
        stringData:
          password: {{ exec "bash" (list "-c" (print "echo " $gkms_omnibus_secrets_base64 "| base64 -d | jq -j '.\"omnibus-gitlab\".gitlab_rb.\"gitlab-rails\".incoming_email_password'")) }}
